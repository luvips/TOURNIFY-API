name: Deploy API to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Descargar el código
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Configurar Java 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Permisos Gradlew
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4. Compilar
      - name: Build with Gradle
        run: ./gradlew clean shadowJar

      # 5. Debug: Listar archivos (Útil si algo falla)
      - name: List files in build/libs
        run: ls -la build/libs/

      # 6. Preparar el JAR (Lógica corregida y ordenada)
      - name: Prepare JAR
        run: |
          # Intentamos encontrar el fat-jar (-all.jar) primero
          if ls build/libs/*-all.jar 1> /dev/null 2>&1; then
            echo "Encontrado JAR versión -all"
            mv build/libs/*-all.jar app.jar
          else
            echo "No se encontró -all.jar, moviendo cualquier .jar disponible"
            mv build/libs/*.jar app.jar
          fi

      # 7. Verificación (Indentación arreglada)
      - name: Verify app.jar exists
        run: |
          if [ -f "app.jar" ]; then
            echo "✅ app.jar encontrado. Listo para subir."
            ls -l app.jar
          else
            echo "❌ ERROR: app.jar NO existe en la raíz."
            exit 1
          fi

      # 8. Pre-Deploy
      - name: Stop Service (Pre-Deploy)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: sudo /opt/apps/backend/scripts/pre-deploy

      # 9. Subir JAR
      - name: Upload JAR via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          source: "app.jar"
          target: "/opt/apps/backend/"

      # 10. Post-Deploy
      - name: Start Service (Post-Deploy)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: sudo /opt/apps/backend/scripts/post-deploy